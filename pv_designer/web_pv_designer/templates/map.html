{% extends "base.html" %}

{% block content %}
    <head>
        <title>Draw on Map</title>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvX9ndMncH71GBqL-w0wOW9tyPbhgXPlQ&libraries=drawing,places"></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
        <style>
            #map {
                height: 100%;
                min-height: 600px;
                width: 100%;
            }

            #actions {
                margin-top: 10px;
            }

            #searchInput {
                width: 100%;
                max-width: 300px;
                padding: 5px;
                margin-bottom: 10px;
            }
        </style>
    </head>
    <body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h1 class="text-center">Photovoltaic Calculator</h1>
                <div class="input-group mb-3">
                    <input id="searchInput" type="text" class="form-control" placeholder="Search for an address...">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="button" onclick="searchAddress()">Search</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div id="map"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div id="actions">
                    <button class="btn btn-danger mb-2" onclick="deleteShape()">Delete</button>
                    <button class="btn btn-success mb-2" onclick="calculateArea()">Calculate Area</button>
                    <button class="btn btn-info mb-2" onclick="takeScreenshot()">Take Screenshot</button>
                    <div id="areaDisplay"></div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <form id="pvCalculatorForm" method="post" action="{% url 'solar_pv_calculator' %}">
        {% csrf_token %}
        <input type="hidden" name="lat" id="latitudeField" value="{{ latitude }}">
        <input type="hidden" name="long" id="longitudeField" value="{{ longitude }}">
        <button id="calculateButton" class="btn btn-primary mt-3" type="submit">Calculate Solar PV</button>
    </form>
    <script>
        var map;
        var drawingManager;
        var selectedShape;
        var shapes = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'),
                {
                    center: {lat: 50, lng: 14},
                    zoom: 21,
                    tilt: 0,
                });

            drawingManager = new google.maps.drawing.DrawingManager({
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [
                        google.maps.drawing.OverlayType.POLYGON,
                        google.maps.drawing.OverlayType.RECTANGLE,
                    ]
                },
                polygonOptions: {
                    editable: true,
                    draggable: true,
                    strokeColor: '#0033ff',
                },
                rectangleOptions: {
                    editable: true,
                    draggable: true,
                    strokeColor: '#0033ff',
                }
            });

            drawingManager.setMap(map);

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function (event) {
                var shape = event.overlay;
                shapes.push(shape);
                google.maps.event.addListener(shape, 'click', function () {
                    selectShape(shape);
                });
                drawingManager.setDrawingMode(null);
                selectShape(shape);
            });

            google.maps.event.addListener(drawingManager, 'drawingmode_changed', clearSelection);

            google.maps.event.addListener(map, 'click', clearSelection);
            searchBoxInit(map);
            google.maps.event.addDomListener(document, 'keyup', function (e) {
                var code = (e.keyCode ? e.keyCode : e.which);
                if (code === 46) {
                    deleteShape();
                }
            });
        }

        function clearSelection() {
            if (selectedShape) {
                selectedShape.setEditable(false);
                selectedShape.setDraggable(false);
                selectedShape = null;
            }
        }

        function selectShape(shape) {
            clearSelection();
            selectedShape = shape;
            shape.setEditable(true);
            shape.setDraggable(true);
        }

        function deleteShape() {
            if (selectedShape) {
                selectedShape.setMap(null); // Remove shape from the map
                var index = shapes.indexOf(selectedShape);
                if (index !== -1) {
                    shapes.splice(index, 1); // Remove shape from the shapes array
                }
                selectedShape = null;
            }
        }

        function calculateArea() {
            area_string = "Plocha:" + '<br>';
            sum = 0;
            i = 0;
            //for each shape in shapes
            console.log(shapes[0]);
            shapes.forEach(function (shape) {
                i++;
                if (shape instanceof google.maps.Polygon) {
                    var area = google.maps.geometry.spherical.computeArea(shape.getPath());
                    area_string += i + ': ' + area.toFixed(2) + " m^2" + '<br>';
                    sum += area;
                } else if (shape instanceof google.maps.Rectangle) {
                    var bounds = shape.getBounds();
                    var area = google.maps.geometry.spherical.computeArea(shape.getBounds());
                    area_string += i + ': ' + area.toFixed(2) + " m^2" + '<br>';
                    sum += area;
                }
            });
            document.getElementById("areaDisplay").innerHTML = area_string + "<br> Celkova plocha: " + sum.toFixed(2) + " m^2";
        }

        function searchBoxInit(map) {
            // Create the search box and link it to the UI element.
            const input = document.getElementById("searchInput");
            const searchBox = new google.maps.places.SearchBox(input);

            // Bias the SearchBox results towards current map's viewport.
            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });
            let markers = [];
            // Listen for the event fired when the user selects a prediction and retrieve
            // more details for that place.
            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();

                if (places.length == 0) {
                    return;
                }

                // Clear out the old markers.
                markers.forEach((marker) => {
                    marker.setMap(null);
                });
                markers = [];

                // For each place, get the icon, name and location.
                const bounds = new google.maps.LatLngBounds();

                places.forEach((place) => {
                    if (!place.geometry || !place.geometry.location) {
                        console.log("Returned place contains no geometry");
                        return;
                    }

                    const icon = {
                        url: place.icon,
                        size: new google.maps.Size(71, 71),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(17, 34),
                        scaledSize: new google.maps.Size(25, 25),
                    };

                    // Create a marker for each place.
                    markers.push(
                        new google.maps.Marker({
                            map,
                            icon,
                            title: place.name,
                            position: place.geometry.location,
                        }),
                    );
                    if (place.geometry.viewport) {
                        // Only geocodes have viewport.
                        bounds.union(place.geometry.viewport);
                    } else {
                        bounds.extend(place.geometry.location);
                    }
                });
                map.fitBounds(bounds);
            });
        }

        function takeScreenshot() {
    // Set the center and zoom of the static image to match the current map view
    const center = map.getCenter();
    const zoom = map.getZoom();

    var mapContainer = $('#map');
    var sizex = mapContainer.width();
    var sizey = mapContainer.height();
    // Construct the URL for the static image
    let staticMapUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${center.lat()},${center.lng()}&zoom=${zoom}&size=${sizex}x${sizey}&maptype=satellite`;

    // Add markers and shapes to the static image URL
    shapes.forEach(function(shape) {
      if (shape instanceof google.maps.Marker) {
        const position = shape.getPosition();
        staticMapUrl += `&markers=color:red%7Clabel:M%7C${position.lat()},${position.lng()}`;
      } else if (shape instanceof google.maps.Polygon) {
        const path = encodePolygon(shape);
        staticMapUrl += `&path=fillcolor:0x00000033%7Ccolor:0x0000FF80%7C${path}`;
      }
    });

    // Add the API key to the static map URL
    staticMapUrl += `&key=AIzaSyDvX9ndMncH71GBqL-w0wOW9tyPbhgXPlQ`;

    // Display the static map URL for debugging purposes
console.log(staticMapUrl);
  }

  function encodePolygon(polygon) {
    var path = polygon.getPath().getArray().map(point => `${point.lat()},${point.lng()}`).join('|');
    const firstPoint = polygon.getPath().getAt(0);
    const lastPoint = polygon.getPath().getAt(polygon.getPath().getLength() - 1);
    if (!firstPoint.equals(lastPoint)) {
      // Add the first point at the end to close the polygon
      path += `|${firstPoint.lat()},${firstPoint.lng()}`;
    }
    return encodeURIComponent(path);
  }

        initMap();

        $('#calculateButton').on('click', function (event) {
            event.preventDefault(); // Prevent the default form submission
            const center = map.getCenter();
            const currentLatitude = center.lat();
            const currentLongitude = center.lng();
            $('#latitudeField').val(currentLatitude);
            $('#longitudeField').val(currentLongitude);
            $('#pvCalculatorForm').submit();
        });

    </script>
    </body>
    </html>

{% endblock %}